<!--
Copyright 2020,2021 Avi Zimmerman

This file is part of kvdi.

kvdi is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

kvdi is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with kvdi.  If not, see <https://www.gnu.org/licenses/>.
-->

<template>
  <div class="wrapper">
    <q-card-section avatar>
      <div class="container">
        <q-checkbox v-model="enabled" color="teal" @input="enableMFA"/>
        <q-item-label>Enable MFA</q-item-label>
      </div>
      <q-item-label caption>If enabled, you will require an additional OTP at login.</q-item-label>
    </q-card-section>
    <div v-if="enabled && !verified && provisioningURI !== ''" class="container">
      <q-card-section>
        <qrcode-vue :value="provisioningURI" :size="200" level="H" />
      </q-card-section>
      <br />
      <q-item-label caption>Scan this QR code to setup MFA</q-item-label>
      <q-item-label caption>If you cannot scan the code above, use the following URI: {{ provisioningURI  }}</q-item-label>

      <q-separator />

      <q-input v-model="verifyToken" dense placeholder="Token" hint="Enter the token generated by the app" />
      <div style="float: right;">
        <q-btn :loading="verifying" color="secondary" @click="verifyMFA" label="Verify" />
      </div>
    </div>
  </div>
</template>

<script lang="ts">
import QrcodeVue from 'qrcode.vue'
import { useConfigStore } from 'src/stores/config';
import { defineComponent } from 'vue';

export default defineComponent({
  name: 'MFAConfig',
  components: { QrcodeVue },
  props: {
    username: {
      type: String
    }
  },
  setup () {
    return {
      enabled: false,
      provisioningURI: '',
      verifyToken: '',
      verifying: false,
      finishedVerifying: false,
      verified: false,
      configStore: useConfigStore()
    }
  },
  methods: {
    setMFAData (data) {
      if (data.enabled) {
        this.enabled = true
        this.verified = data.verified
        this.provisioningURI = data.provisioningURI
      } else {
        this.enabled = false
        this.verified = false
        this.provisioningURI = ''
      }
      if (this.configStore.authMethod !== 'oidc') {
        this.configStore.emitter.emit('reload-users')
      }
    },
    enableMFA (val) {
      this.configStore.axios.put(`/api/users/${this.username}/mfa`, { enabled: val })
        .then((res) => {
          this.setMFAData(res.data)
        })
        .catch((err) => {
          this.configStore.emitter.emit('notify-error', err)
        })
    },
    async verifyMFA () {
      this.verifying = true
      await new Promise(resolve => setTimeout(resolve, 500))
      this.configStore.axios.put(`/api/users/${this.username}/mfa/verify`, { otp: this.verifyToken })
        .then((res) => {
          this.setMFAData(res.data)
          this.$q.notify({
            color: 'green-4',
            textColor: 'white',
            icon: 'cloud_done',
            message: `Succesfully configured MFA for ${this.username}'`
          })
        })
        .catch((err) => {
          this.configStore.emitter.emit('notify-error', err)
        })
      this.verifying = false
    }
  },
  mounted () {
    this.$nextTick().then(() => {
      this.configStore.axios.get(`/api/users/${this.username}/mfa`)
        .then((res) => {
          this.setMFAData(res.data)
        })
        .catch((err) => {
          this.configStore.emitter.emit('notify-error', err)
        })
    })
  }
})
</script>

<style scoped>
.wrapper div {
  display: block;
  position: relative;
}
.container div {
  margin: 5px auto;
  display: inline-block;
}
</style>
